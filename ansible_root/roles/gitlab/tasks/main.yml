- name: gitlab | Install Gitlab dependencies
  become: yes
  become_user: root
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - ca-certificates
    - curl
    - openssh-server
    - perl
    - tzdata
  tags:
    - gitlab
    - pre-install

- name: gitlab | Run custom Gitlab (CE) script to setup APT configuration
  become: yes
  become_user: root
  shell: |
    curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
  tags:
    - gitlab
    - pre-install

- name: gitlab | Install Gitlab (CE)
  become: yes
  become_user: root
  ansible.builtin.apt:
    name: gitlab-ce={{ gitlab__version }}-ce.0
    state: present
  environment:
    EXTERNAL_URL: "{{ gitlab__hostname_fqdn }}"
    GITLAB_ROOT_PASSWORD: "{{ gitlab__root_password }}"
  tags:
    - gitlab
    - install

- name: gitlab | Bind Redis to an IP address (0.0.0.0) to enable Redis TCP support
  become: yes
  become_user: root
  ansible.builtin.lineinfile:
    state: present
    path: /etc/gitlab/gitlab.rb
    line: "redis['bind'] = '0.0.0.0'"
    insertafter: "^# redis\\['bind'\\].*"
  tags:
    - gitlab
    - configure
  notify:
    - gitlab | reconfigure

- name: gitlab | Set exposed Redis TCP port
  become: yes
  become_user: root
  ansible.builtin.lineinfile:
    state: present
    path: /etc/gitlab/gitlab.rb
    line: "redis['port'] = 6379"
    insertafter: "^# redis\\['port'\\].*"
  tags:
    - gitlab
    - configure
  notify:
    - gitlab | reconfigure
