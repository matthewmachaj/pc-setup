---
#-------------------------------------------------------------------------------
# SEE: https://kifarunix.com/configure-local-dns-server-using-dnsmasq-on-ubuntu-20-04/
#-------------------------------------------------------------------------------

- name: Disable system-resolved
  become: yes
  service:
    name: systemd-resolved
    state: stopped
    enabled: false

# NOTE: this must be done before installing dnsmasq from APT b/c otherwise
#       APT cannot resolve the package servers due to systemd-resolved
#       being disabled above (we possibly could re-arrange step order to
#       avoid this at some point)
- name: Replace resolv.conf that was managed by system-resolved
  become: yes
  copy:
    src: resolv.conf
    dest: /etc/resolv.conf
    mode: 0644
    owner: root
    group: root
    backup: yes

- name: Install dnsmasq from APT
  become: yes
  apt:
    name: dnsmasq
    state: present

# NOTE: 3/2/21 - cannot seem to run the followng currently due to link below so
#       commenting this step out:
#          - https://github.com/ansible/ansible/issues/71528
#- name: Ensure dnsmasq service is enabled and runing
  #become: yes
  #service:
    #name: dnsmasq
    #state: started
    #enabled: true

# NOTE: this is needed b/c the restart handler will fail in the step to deploy
#       dnsmasq.conf if service isn't up yet
- name: Wait for dnsmasq service to start so we can deploy a new dnsmasq.conf
  wait_for:
    state: started
    port: 53
    timeout: 5
    msg: "port 53 is not open yet so dnsmasq service did not start properly"

- name: Setup initial /etc/dnsmasq.conf
  become: yes
  template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.conf
    mode: 0644
    owner: root
    group: root
  notify:
  - dnsmasq-service-restart

